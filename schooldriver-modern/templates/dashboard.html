{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<script src="{% static 'js/chart.min.js' %}"></script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; Analytics Dashboard
</div>
{% endblock %}

{% block content %}
<div id="content" class="dashboard-content">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Admissions Analytics Dashboard</h1>
        <p class="dashboard-subtitle">Real-time insights into your admissions pipeline</p>
        <div class="dashboard-live-indicator">
            <div class="live-dot"></div>
            <span class="live-text">Live updates every 15 seconds</span>
        </div>
    </div>

    <div class="dashboard-container">

        <!-- Quick Action Buttons -->
        <div class="dashboard-actions">
            <button onclick="downloadCSV()" class="btn-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>Download CSV</span>
            </button>
            
            <button onclick="refreshDataNow()" class="btn-secondary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Refresh Data</span>
            </button>
            
            <a href="/admin/admissions/applicant/" class="btn-tertiary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>Admissions Report</span>
            </a>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-icon blue">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Applications</p>
                        <p class="stat-value">{{ dashboard_data.summary.total_applications }}</p>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-icon green">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Acceptances</p>
                        <p class="stat-value">{{ dashboard_data.summary.total_acceptances }}</p>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-icon yellow">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Acceptance Rate</p>
                        <p class="stat-value">{{ dashboard_data.summary.acceptance_rate }}%</p>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-icon purple">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Pending Review</p>
                        <p class="stat-value">{{ dashboard_data.summary.pending_applications }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Admission Pipeline Progress (Funnel Chart) -->
            <div class="chart-card">
                <h3 class="chart-title">Admission Pipeline Progress</h3>
                <div class="chart-container">
                    <canvas id="pipelineChart"></canvas>
                </div>
            </div>

            <!-- Document Completion Rates (Bar Chart) -->
            <div class="chart-card">
                <h3 class="chart-title">Document Completion Rates</h3>
                <div class="chart-container">
                    <canvas id="documentsChart"></canvas>
                </div>
            </div>

            <!-- Applicant Status Distribution (Pie Chart) -->
            <div class="chart-card">
                <h3 class="chart-title">Applicant Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Monthly Admission Trends (Line Chart) -->
            <div class="chart-card">
                <h3 class="chart-title">Monthly Admission Trends</h3>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
    // Dashboard data from Django view
    const dashboardData = {{ dashboard_data_json|safe }};
    
    // Chart instances for updates
    let pipelineChart, documentsChart, statusChart, trendsChart;
    
    // Wait for Chart.js to be fully loaded before setting defaults
    function setupChartDefaults() {
        // Dark theme Chart.js defaults
        Chart.defaults.color = '#E6EDF3';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.backgroundColor = 'rgba(30, 136, 229, 0.2)';
        Chart.defaults.plugins.legend.labels.color = '#E6EDF3';
        Chart.defaults.scales.category.ticks.color = '#E6EDF3';
        Chart.defaults.scales.linear.ticks.color = '#E6EDF3';
        Chart.defaults.scales.category.grid.color = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.scales.linear.grid.color = 'rgba(255, 255, 255, 0.1)';
    }

    // Initialize all charts
    function initializeCharts() {
        // Ensure Chart.js defaults are set for dark theme
        setupChartDefaults();
        // 1. Admission Pipeline Progress (Funnel Chart - using horizontal bar)
        const pipelineCtx = document.getElementById('pipelineChart').getContext('2d');
        pipelineChart = new Chart(pipelineCtx, {
            type: 'bar',
            data: {
                labels: dashboardData.pipeline.labels,
                datasets: [{
                    label: 'Applicants',
                    data: dashboardData.pipeline.values,
                    backgroundColor: dashboardData.pipeline.colors,
                    borderColor: dashboardData.pipeline.colors.map(color => color + 'CC'),
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: false,
                        labels: { color: '#E6EDF3' }
                    },
                    title: { display: false }
                },
                scales: {
                    x: { 
                        beginAtZero: true,
                        ticks: { color: '#E6EDF3' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#E6EDF3' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });

        // 2. Document Completion Rates (Bar Chart)
        const documentsCtx = document.getElementById('documentsChart').getContext('2d');
        documentsChart = new Chart(documentsCtx, {
            type: 'bar',
            data: {
                labels: dashboardData.documents.labels,
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: dashboardData.documents.completion_rates,
                    backgroundColor: dashboardData.documents.colors,
                    borderColor: dashboardData.documents.colors.map(color => color + 'CC'),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: false,
                        labels: { color: '#E6EDF3' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#E6EDF3' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: { 
                        beginAtZero: true,
                        max: 100,
                        ticks: { 
                            color: '#E6EDF3',
                            callback: value => value + '%' 
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });

        // 3. Applicant Status Distribution (Pie Chart)
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        statusChart = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: dashboardData.status.labels,
                datasets: [{
                    data: dashboardData.status.values,
                    backgroundColor: dashboardData.status.colors,
                    borderColor: '#161B22',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            padding: 20,
                            color: '#E6EDF3'
                        }
                    }
                }
            }
        });

        // 4. Monthly Admission Trends (Line Chart)
        const trendsCtx = document.getElementById('trendsChart').getContext('2d');
        trendsChart = new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: dashboardData.trends.labels,
                datasets: [
                    {
                        label: 'Applications',
                        data: dashboardData.trends.applications,
                        borderColor: '#1E88E5',
                        backgroundColor: 'rgba(30, 136, 229, 0.2)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Acceptances',
                        data: dashboardData.trends.acceptances,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'top',
                        labels: { color: '#E6EDF3' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#E6EDF3' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: { 
                        beginAtZero: true,
                        ticks: { color: '#E6EDF3' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    // Realtime update function (every 15 seconds)
    function updateChartData() {
        console.log('Updating chart data...');
        
        // Add visual feedback
        document.querySelectorAll('.chart-container').forEach(container => {
            container.classList.add('updating');
        });

        // Update pipeline data
        const pipelineIdx = Math.floor(Math.random() * dashboardData.pipeline.values.length);
        dashboardData.pipeline.values[pipelineIdx] += Math.floor(Math.random() * 20) - 10;
        pipelineChart.data.datasets[0].data = [...dashboardData.pipeline.values];
        pipelineChart.update('active');

        // Update documents data
        const docIdx = Math.floor(Math.random() * dashboardData.documents.completion_rates.length);
        dashboardData.documents.completion_rates[docIdx] = Math.max(70, Math.min(100, 
            dashboardData.documents.completion_rates[docIdx] + Math.floor(Math.random() * 6) - 3));
        documentsChart.data.datasets[0].data = [...dashboardData.documents.completion_rates];
        documentsChart.update('active');

        // Update status data
        const statusIdx = Math.floor(Math.random() * dashboardData.status.values.length);
        dashboardData.status.values[statusIdx] += Math.floor(Math.random() * 10) - 5;
        statusChart.data.datasets[0].data = [...dashboardData.status.values];
        statusChart.update('active');

        // Update trends data (add to current month)
        const currentMonthIdx = new Date().getMonth();
        dashboardData.trends.applications[currentMonthIdx] += Math.floor(Math.random() * 5);
        dashboardData.trends.acceptances[currentMonthIdx] += Math.floor(Math.random() * 3);
        trendsChart.data.datasets[0].data = [...dashboardData.trends.applications];
        trendsChart.data.datasets[1].data = [...dashboardData.trends.acceptances];
        trendsChart.update('active');

        // Remove visual feedback
        setTimeout(() => {
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.remove('updating');
            });
        }, 1000);
    }

    // Quick action functions
    function downloadCSV() {
        // Placeholder for CSV download functionality
        alert('CSV download will be implemented in a future version.');
        console.log('CSV download requested');
    }
    
    function refreshDataNow() {
        console.log('Manual refresh triggered');
        updateChartData();
    }

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard DOM loaded, Chart.js version:', Chart.version);
        console.log('Dashboard data received:', dashboardData);
        
        try {
            initializeCharts();
            console.log('Dashboard initialized with 4 interactive charts');
            
            // Start realtime updates every 15 seconds
            setInterval(updateChartData, 15000);
        } catch (error) {
            console.error('Failed to initialize charts:', error);
            
            // Show error message to user
            const errorMessage = document.createElement('div');
            errorMessage.innerHTML = '<p style="color: #EF4444; text-align: center; padding: 2rem;">Chart initialization failed. Please refresh the page.</p>';
            document.querySelector('.charts-grid').prepend(errorMessage);
        }
    });
</script>
{% endblock %}
