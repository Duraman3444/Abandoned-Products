{% extends "teacher_portal/base.html" %}
{% load static %}

{% block title %}Custom Report Builder{% endblock %}

{% block extra_css %}
<style>
.report-builder {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.builder-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
}

.builder-content {
    padding: 2rem;
}

.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    align-items: center;
    margin: 0 1rem;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step.completed {
    opacity: 1;
    color: #28a745;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 0.5rem;
}

.step.active .step-number {
    background: #667eea;
    color: white;
}

.step.completed .step-number {
    background: #28a745;
    color: white;
}

.step-title {
    font-size: 0.875rem;
    font-weight: 500;
}

.builder-step {
    display: none;
}

.builder-step.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.data-source-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.data-source-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.data-source-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.data-source-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
}

.data-source-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #667eea;
}

.data-source-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.data-source-description {
    font-size: 0.875rem;
    color: #6c757d;
}

.field-selector {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.field-category {
    margin-bottom: 1.5rem;
}

.field-category-title {
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.field-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
}

.field-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: white;
    border-radius: 4px;
    border: 1px solid #e9ecef;
    cursor: pointer;
    transition: all 0.2s ease;
}

.field-item:hover {
    background: #f8f9fa;
    border-color: #667eea;
}

.field-item.selected {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.field-checkbox {
    margin-right: 0.5rem;
}

.filter-builder {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.filter-rule {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 6px;
    margin-bottom: 1rem;
    border: 1px solid #e9ecef;
}

.filter-field {
    min-width: 150px;
}

.filter-operator {
    min-width: 120px;
}

.filter-value {
    flex: 1;
}

.filter-remove {
    color: #dc3545;
    cursor: pointer;
    padding: 0.5rem;
}

.filter-remove:hover {
    background: #f8d7da;
    border-radius: 4px;
}

.add-filter-btn {
    border: 2px dashed #e9ecef;
    border-radius: 6px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.add-filter-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.visualization-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.viz-option {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.viz-option:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.viz-option.selected {
    border-color: #667eea;
    background: #f8f9ff;
}

.viz-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #667eea;
}

.viz-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.viz-description {
    font-size: 0.875rem;
    color: #6c757d;
}

.report-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    min-height: 300px;
}

.preview-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: #6c757d;
    flex-direction: column;
}

.preview-placeholder i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.step-navigation {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
}

.nav-buttons {
    display: flex;
    gap: 1rem;
}

.saved-reports {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.saved-report-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    margin-bottom: 1rem;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.saved-report-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.report-info {
    flex: 1;
}

.report-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.report-meta {
    font-size: 0.875rem;
    color: #6c757d;
}

.report-actions {
    display: flex;
    gap: 0.5rem;
}

.quick-templates {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.template-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    background: white;
    transition: all 0.2s ease;
    cursor: pointer;
}

.template-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.template-icon {
    font-size: 2rem;
    color: #667eea;
    margin-bottom: 1rem;
}

.template-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.template-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.template-fields {
    font-size: 0.75rem;
    color: #6c757d;
}

.export-options {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.export-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: #495057;
}

.export-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
    color: #667eea;
}

.schedule-options {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-chart-pie me-2"></i>Custom Report Builder</h2>
            <p class="text-muted mb-0">Create personalized analytics reports and dashboards</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="loadTemplate()">
                <i class="fas fa-magic me-2"></i>Use Template
            </button>
            <button class="btn btn-success me-2" onclick="toggleSavedReports()">
                <i class="fas fa-bookmark me-2"></i>Saved Reports
            </button>
            <button class="btn btn-primary" onclick="startNewReport()">
                <i class="fas fa-plus me-2"></i>New Report
            </button>
        </div>
    </div>

    <!-- Quick Templates -->
    <div id="quickTemplates" class="saved-reports">
        <h5 class="mb-3"><i class="fas fa-magic me-2"></i>Quick Report Templates</h5>
        <div class="quick-templates">
            <div class="template-card" onclick="useTemplate('student_performance')">
                <div class="template-icon"><i class="fas fa-user-graduate"></i></div>
                <div class="template-title">Student Performance Summary</div>
                <div class="template-description">Comprehensive overview of student grades, attendance, and progress</div>
                <div class="template-fields">Fields: GPA, Attendance Rate, Assignment Completion, Grade Trends</div>
            </div>
            <div class="template-card" onclick="useTemplate('course_analytics')">
                <div class="template-icon"><i class="fas fa-book"></i></div>
                <div class="template-title">Course Analytics Dashboard</div>
                <div class="template-description">Analyze performance metrics across all courses</div>
                <div class="template-fields">Fields: Class Averages, Grade Distribution, Engagement Metrics</div>
            </div>
            <div class="template-card" onclick="useTemplate('attendance_report')">
                <div class="template-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="template-title">Attendance Analysis</div>
                <div class="template-description">Detailed attendance patterns and trends</div>
                <div class="template-fields">Fields: Daily Rates, Chronic Absenteeism, Weekly Patterns</div>
            </div>
            <div class="template-card" onclick="useTemplate('intervention_tracking')">
                <div class="template-icon"><i class="fas fa-hand-holding-heart"></i></div>
                <div class="template-title">Intervention Tracking</div>
                <div class="template-description">Monitor at-risk students and intervention effectiveness</div>
                <div class="template-fields">Fields: Risk Factors, Intervention Success, Progress Tracking</div>
            </div>
        </div>
    </div>

    <!-- Saved Reports (Hidden by default) -->
    <div id="savedReports" class="saved-reports" style="display: none;">
        <h5 class="mb-3"><i class="fas fa-bookmark me-2"></i>Your Saved Reports</h5>
        {% for report in saved_reports %}
            <div class="saved-report-item">
                <div class="report-info">
                    <div class="report-title">{{ report.title }}</div>
                    <div class="report-meta">
                        Created: {{ report.created_date|date:"M j, Y" }} • 
                        Last run: {{ report.last_run|date:"M j, g:i A" }} • 
                        {{ report.fields_count }} fields
                    </div>
                </div>
                <div class="report-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="runReport('{{ report.id }}')">
                        <i class="fas fa-play me-1"></i>Run
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editReport('{{ report.id }}')">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="scheduleReport('{{ report.id }}')">
                        <i class="fas fa-clock me-1"></i>Schedule
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteReport('{{ report.id }}')">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        {% empty %}
            <div class="text-center py-4 text-muted">
                <i class="fas fa-bookmark fa-2x mb-2"></i>
                <p>No saved reports yet. Create your first custom report!</p>
            </div>
        {% endfor %}
    </div>

    <!-- Report Builder -->
    <div class="report-builder">
        <div class="builder-header">
            <h4 class="mb-1">Report Builder</h4>
            <p class="mb-0 opacity-75">Follow the steps below to create your custom report</p>
        </div>

        <div class="builder-content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step-indicator-1">
                    <div class="step-number">1</div>
                    <div class="step-title">Data Source</div>
                </div>
                <div class="step" id="step-indicator-2">
                    <div class="step-number">2</div>
                    <div class="step-title">Select Fields</div>
                </div>
                <div class="step" id="step-indicator-3">
                    <div class="step-number">3</div>
                    <div class="step-title">Add Filters</div>
                </div>
                <div class="step" id="step-indicator-4">
                    <div class="step-number">4</div>
                    <div class="step-title">Visualization</div>
                </div>
                <div class="step" id="step-indicator-5">
                    <div class="step-number">5</div>
                    <div class="step-title">Preview & Save</div>
                </div>
            </div>

            <!-- Step 1: Data Source Selection -->
            <div class="builder-step active" id="step-1">
                <h5>Step 1: Choose Your Data Source</h5>
                <p class="text-muted mb-3">Select the primary data source for your report</p>
                
                <div class="data-source-grid">
                    <div class="data-source-card" onclick="selectDataSource('students')">
                        <div class="data-source-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="data-source-title">Student Data</div>
                        <div class="data-source-description">Student profiles, enrollment, demographics</div>
                    </div>
                    <div class="data-source-card" onclick="selectDataSource('grades')">
                        <div class="data-source-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="data-source-title">Grade & Assessment</div>
                        <div class="data-source-description">Grades, assignments, test scores, GPA</div>
                    </div>
                    <div class="data-source-card" onclick="selectDataSource('attendance')">
                        <div class="data-source-icon"><i class="fas fa-calendar-check"></i></div>
                        <div class="data-source-title">Attendance</div>
                        <div class="data-source-description">Daily attendance, absences, tardiness</div>
                    </div>
                    <div class="data-source-card" onclick="selectDataSource('courses')">
                        <div class="data-source-icon"><i class="fas fa-book"></i></div>
                        <div class="data-source-title">Course Data</div>
                        <div class="data-source-description">Course enrollment, schedules, performance</div>
                    </div>
                    <div class="data-source-card" onclick="selectDataSource('behavior')">
                        <div class="data-source-icon"><i class="fas fa-clipboard-list"></i></div>
                        <div class="data-source-title">Behavior & Discipline</div>
                        <div class="data-source-description">Behavior incidents, disciplinary actions</div>
                    </div>
                    <div class="data-source-card" onclick="selectDataSource('custom')">
                        <div class="data-source-icon"><i class="fas fa-database"></i></div>
                        <div class="data-source-title">Custom Query</div>
                        <div class="data-source-description">Advanced users: Write custom SQL</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Field Selection -->
            <div class="builder-step" id="step-2">
                <h5>Step 2: Select Fields to Include</h5>
                <p class="text-muted mb-3">Choose which data fields to include in your report</p>
                
                <div class="field-selector">
                    <div class="field-category">
                        <div class="field-category-title">Basic Information</div>
                        <div class="field-list">
                            <div class="field-item" onclick="toggleField(this, 'student_name')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Student Name</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'student_id')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Student ID</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'grade_level')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Grade Level</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'enrollment_date')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Enrollment Date</span>
                            </div>
                        </div>
                    </div>

                    <div class="field-category">
                        <div class="field-category-title">Academic Performance</div>
                        <div class="field-list">
                            <div class="field-item" onclick="toggleField(this, 'current_gpa')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Current GPA</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'semester_gpa')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Semester GPA</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'class_rank')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Class Rank</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'credits_earned')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Credits Earned</span>
                            </div>
                        </div>
                    </div>

                    <div class="field-category">
                        <div class="field-category-title">Attendance & Engagement</div>
                        <div class="field-list">
                            <div class="field-item" onclick="toggleField(this, 'attendance_rate')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Attendance Rate</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'total_absences')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Total Absences</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'tardies')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Tardies</span>
                            </div>
                            <div class="field-item" onclick="toggleField(this, 'engagement_score')">
                                <input type="checkbox" class="field-checkbox">
                                <span>Engagement Score</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Filters -->
            <div class="builder-step" id="step-3">
                <h5>Step 3: Add Filters (Optional)</h5>
                <p class="text-muted mb-3">Filter your data to focus on specific criteria</p>
                
                <div class="filter-builder">
                    <div id="filter-rules">
                        <!-- Filter rules will be added dynamically -->
                    </div>
                    <div class="add-filter-btn" onclick="addFilterRule()">
                        <i class="fas fa-plus me-2"></i>Add Filter Rule
                    </div>
                </div>
            </div>

            <!-- Step 4: Visualization -->
            <div class="builder-step" id="step-4">
                <h5>Step 4: Choose Visualization Type</h5>
                <p class="text-muted mb-3">Select how you want to display your data</p>
                
                <div class="visualization-options">
                    <div class="viz-option" onclick="selectVisualization('table')">
                        <div class="viz-icon"><i class="fas fa-table"></i></div>
                        <div class="viz-title">Data Table</div>
                        <div class="viz-description">Traditional tabular format with sorting and pagination</div>
                    </div>
                    <div class="viz-option" onclick="selectVisualization('chart')">
                        <div class="viz-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="viz-title">Bar Chart</div>
                        <div class="viz-description">Compare values across different categories</div>
                    </div>
                    <div class="viz-option" onclick="selectVisualization('line')">
                        <div class="viz-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="viz-title">Line Chart</div>
                        <div class="viz-description">Show trends and changes over time</div>
                    </div>
                    <div class="viz-option" onclick="selectVisualization('pie')">
                        <div class="viz-icon"><i class="fas fa-chart-pie"></i></div>
                        <div class="viz-title">Pie Chart</div>
                        <div class="viz-description">Display proportions and percentages</div>
                    </div>
                    <div class="viz-option" onclick="selectVisualization('dashboard')">
                        <div class="viz-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div class="viz-title">Dashboard</div>
                        <div class="viz-description">Multiple visualizations in one view</div>
                    </div>
                    <div class="viz-option" onclick="selectVisualization('summary')">
                        <div class="viz-icon"><i class="fas fa-list-alt"></i></div>
                        <div class="viz-title">Summary Cards</div>
                        <div class="viz-description">Key metrics in card format</div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Preview & Save -->
            <div class="builder-step" id="step-5">
                <h5>Step 5: Preview & Save Your Report</h5>
                <p class="text-muted mb-3">Review your report configuration and save for future use</p>
                
                <div class="report-preview">
                    <div class="preview-placeholder">
                        <i class="fas fa-eye"></i>
                        <p>Report preview will appear here</p>
                        <button class="btn btn-primary" onclick="generatePreview()">Generate Preview</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="reportName" class="form-label">Report Name</label>
                        <input type="text" class="form-control" id="reportName" placeholder="Enter report name...">
                    </div>
                    <div class="col-md-6">
                        <label for="reportDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="reportDescription" placeholder="Brief description...">
                    </div>
                </div>

                <div class="export-options">
                    <div class="export-btn" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf"></i>
                        <span>Export as PDF</span>
                    </div>
                    <div class="export-btn" onclick="exportReport('excel')">
                        <i class="fas fa-file-excel"></i>
                        <span>Export to Excel</span>
                    </div>
                    <div class="export-btn" onclick="exportReport('csv')">
                        <i class="fas fa-file-csv"></i>
                        <span>Export as CSV</span>
                    </div>
                    <div class="export-btn" onclick="shareReport()">
                        <i class="fas fa-share"></i>
                        <span>Share Report</span>
                    </div>
                </div>

                <div class="schedule-options">
                    <h6><i class="fas fa-clock me-2"></i>Schedule Automatic Reports</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Frequency</label>
                            <select class="form-select">
                                <option value="">No Schedule</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email Recipients</label>
                            <input type="email" class="form-control" placeholder="admin@school.edu">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Delivery Time</label>
                            <input type="time" class="form-control" value="08:00">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="step-navigation">
                <div>
                    <small class="text-muted">Step <span id="current-step">1</span> of 5</small>
                </div>
                <div class="nav-buttons">
                    <button class="btn btn-outline-secondary" id="prev-btn" onclick="previousStep()" disabled>
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </button>
                    <button class="btn btn-primary" id="next-btn" onclick="nextStep()">
                        Next<i class="fas fa-arrow-right ms-2"></i>
                    </button>
                    <button class="btn btn-success" id="save-btn" onclick="saveReport()" style="display: none;">
                        <i class="fas fa-save me-2"></i>Save Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(255,255,255,0.8); z-index: 1050;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Building your custom report...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentStep = 1;
let selectedDataSource = '';
let selectedFields = [];
let filterRules = [];
let selectedVisualization = '';

// Step navigation
function nextStep() {
    if (currentStep < 5) {
        if (validateCurrentStep()) {
            hideStep(currentStep);
            currentStep++;
            showStep(currentStep);
            updateStepIndicator();
            updateNavigation();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        hideStep(currentStep);
        currentStep--;
        showStep(currentStep);
        updateStepIndicator();
        updateNavigation();
    }
}

function showStep(step) {
    document.getElementById(`step-${step}`).classList.add('active');
}

function hideStep(step) {
    document.getElementById(`step-${step}`).classList.remove('active');
}

function updateStepIndicator() {
    // Update step indicators
    for (let i = 1; i <= 5; i++) {
        const indicator = document.getElementById(`step-indicator-${i}`);
        indicator.classList.remove('active', 'completed');
        
        if (i < currentStep) {
            indicator.classList.add('completed');
        } else if (i === currentStep) {
            indicator.classList.add('active');
        }
    }
    
    document.getElementById('current-step').textContent = currentStep;
}

function updateNavigation() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const saveBtn = document.getElementById('save-btn');
    
    prevBtn.disabled = currentStep === 1;
    
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
    }
}

function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            if (!selectedDataSource) {
                alert('Please select a data source to continue.');
                return false;
            }
            break;
        case 2:
            if (selectedFields.length === 0) {
                alert('Please select at least one field to include in your report.');
                return false;
            }
            break;
        case 4:
            if (!selectedVisualization) {
                alert('Please select a visualization type.');
                return false;
            }
            break;
    }
    return true;
}

// Data source selection
function selectDataSource(source) {
    // Remove previous selection
    document.querySelectorAll('.data-source-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select new source
    event.target.closest('.data-source-card').classList.add('selected');
    selectedDataSource = source;
    
    // Update field options based on selected source
    updateFieldOptions(source);
}

function updateFieldOptions(source) {
    // This would dynamically update the field options based on the selected data source
    console.log(`Updating field options for: ${source}`);
}

// Field selection
function toggleField(element, fieldName) {
    const checkbox = element.querySelector('.field-checkbox');
    const isSelected = element.classList.contains('selected');
    
    if (isSelected) {
        element.classList.remove('selected');
        checkbox.checked = false;
        selectedFields = selectedFields.filter(field => field !== fieldName);
    } else {
        element.classList.add('selected');
        checkbox.checked = true;
        selectedFields.push(fieldName);
    }
}

// Filter management
function addFilterRule() {
    const filterRulesContainer = document.getElementById('filter-rules');
    const ruleId = Date.now();
    
    const ruleHtml = `
        <div class="filter-rule" id="filter-rule-${ruleId}">
            <select class="form-select filter-field">
                <option value="">Select Field</option>
                <option value="grade_level">Grade Level</option>
                <option value="gpa">GPA</option>
                <option value="attendance_rate">Attendance Rate</option>
                <option value="enrollment_date">Enrollment Date</option>
            </select>
            <select class="form-select filter-operator">
                <option value="equals">Equals</option>
                <option value="not_equals">Not Equals</option>
                <option value="greater_than">Greater Than</option>
                <option value="less_than">Less Than</option>
                <option value="contains">Contains</option>
            </select>
            <input type="text" class="form-control filter-value" placeholder="Enter value">
            <div class="filter-remove" onclick="removeFilterRule('${ruleId}')">
                <i class="fas fa-times"></i>
            </div>
        </div>
    `;
    
    filterRulesContainer.insertAdjacentHTML('beforeend', ruleHtml);
}

function removeFilterRule(ruleId) {
    document.getElementById(`filter-rule-${ruleId}`).remove();
}

// Visualization selection
function selectVisualization(vizType) {
    // Remove previous selection
    document.querySelectorAll('.viz-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Select new visualization
    event.target.closest('.viz-option').classList.add('selected');
    selectedVisualization = vizType;
}

// Report preview and save
function generatePreview() {
    showLoading();
    
    // Simulate generating preview
    setTimeout(() => {
        hideLoading();
        const previewContainer = document.querySelector('.report-preview');
        previewContainer.innerHTML = `
            <div class="row">
                <div class="col-md-3 text-center">
                    <h4 class="text-primary">156</h4>
                    <small class="text-muted">Total Students</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-success">3.42</h4>
                    <small class="text-muted">Average GPA</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-info">94.2%</h4>
                    <small class="text-muted">Attendance Rate</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-warning">23</h4>
                    <small class="text-muted">At Risk</small>
                </div>
            </div>
            <div class="mt-3">
                <canvas id="previewChart" width="400" height="200"></canvas>
            </div>
        `;
        
        // Create sample chart
        const ctx = document.getElementById('previewChart').getContext('2d');
        new Chart(ctx, {
            type: selectedVisualization === 'table' ? 'bar' : selectedVisualization,
            data: {
                labels: ['Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                datasets: [{
                    label: 'Student Count',
                    data: [42, 38, 45, 31],
                    backgroundColor: ['#667eea', '#764ba2', '#667eea', '#764ba2']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }, 2000);
}

function saveReport() {
    const reportName = document.getElementById('reportName').value;
    const reportDescription = document.getElementById('reportDescription').value;
    
    if (!reportName.trim()) {
        alert('Please enter a report name.');
        return;
    }
    
    showLoading();
    
    // Simulate saving report
    setTimeout(() => {
        hideLoading();
        alert('Report saved successfully!');
        // Reset form or redirect
        startNewReport();
    }, 1500);
}

// Template and saved report functions
function useTemplate(templateId) {
    if (confirm('Load this template? This will reset your current progress.')) {
        showLoading();
        
        // Simulate loading template
        setTimeout(() => {
            hideLoading();
            alert(`Template "${templateId}" loaded!`);
            // Pre-populate form based on template
            selectedDataSource = 'students';
            currentStep = 2;
            showStep(2);
            hideStep(1);
            updateStepIndicator();
            updateNavigation();
        }, 1000);
    }
}

function toggleSavedReports() {
    const savedReports = document.getElementById('savedReports');
    const quickTemplates = document.getElementById('quickTemplates');
    
    if (savedReports.style.display === 'none') {
        savedReports.style.display = 'block';
        quickTemplates.style.display = 'none';
    } else {
        savedReports.style.display = 'none';
        quickTemplates.style.display = 'block';
    }
}

function runReport(reportId) {
    showLoading();
    setTimeout(() => {
        hideLoading();
        alert(`Running report ${reportId}...`);
    }, 1000);
}

function editReport(reportId) {
    if (confirm('Edit this report? This will load the report configuration into the builder.')) {
        showLoading();
        setTimeout(() => {
            hideLoading();
            alert(`Loading report ${reportId} for editing...`);
        }, 1000);
    }
}

function scheduleReport(reportId) {
    alert(`Schedule report ${reportId} functionality would be implemented here.`);
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        showLoading();
        setTimeout(() => {
            hideLoading();
            alert(`Report ${reportId} deleted.`);
            location.reload();
        }, 1000);
    }
}

function startNewReport() {
    if (confirm('Start a new report? This will reset your current progress.')) {
        // Reset form
        currentStep = 1;
        selectedDataSource = '';
        selectedFields = [];
        filterRules = [];
        selectedVisualization = '';
        
        // Reset UI
        document.querySelectorAll('.builder-step').forEach(step => step.classList.remove('active'));
        document.getElementById('step-1').classList.add('active');
        
        document.querySelectorAll('.data-source-card').forEach(card => card.classList.remove('selected'));
        document.querySelectorAll('.field-item').forEach(item => {
            item.classList.remove('selected');
            item.querySelector('.field-checkbox').checked = false;
        });
        document.querySelectorAll('.viz-option').forEach(option => option.classList.remove('selected'));
        
        document.getElementById('filter-rules').innerHTML = '';
        document.getElementById('reportName').value = '';
        document.getElementById('reportDescription').value = '';
        
        updateStepIndicator();
        updateNavigation();
    }
}

// Export functions
function exportReport(format) {
    showLoading();
    
    setTimeout(() => {
        hideLoading();
        alert(`Report exported as ${format.toUpperCase()}!`);
    }, 1500);
}

function shareReport() {
    const reportUrl = window.location.origin + '/reports/shared/123abc';
    
    if (navigator.share) {
        navigator.share({
            title: 'Custom Report',
            text: 'Check out this custom report',
            url: reportUrl
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(reportUrl).then(() => {
            alert('Report link copied to clipboard!');
        });
    }
}

// Utility functions
function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('d-none');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateStepIndicator();
    updateNavigation();
});
</script>
{% endblock %}
